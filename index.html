<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kingdom Alerting</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    #messagesContainer { border: 1px solid #ccc; padding: 10px; max-height: 300px; overflow-y: auto; background: #fff; margin-bottom: 10px; }
    .message-item { border-left: 4px solid #667eea; padding: 8px; margin-bottom: 5px; }
    .message-item.blocked { border-left-color: red; background: #fee; }
    .compose-area, .blocklist-manager { margin-bottom: 10px; }
    input, textarea, button { padding: 5px; margin-right: 5px; }
    .blocked-word { background: #c53030; color: white; padding: 2px 5px; margin-right: 3px; border-radius: 3px; display: inline-block; }
    .remove-word { cursor: pointer; margin-left: 3px; color: white; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Kingdom Alerting üõ°Ô∏è</h1>
  <div id="messagesContainer">
    <p>No messages yet.</p>
  </div>

  <div class="compose-area">
    <textarea id="messageInput" placeholder="Type your message..." rows="3" cols="50"></textarea>
    <button id="sendButton">Send</button>
  </div>

  <div class="blocklist-manager">
    <h3>Content Filter Management</h3>
    <input type="text" id="newWordInput" placeholder="Add word to block...">
    <button id="addWordButton">Add Word</button>
    <div id="blocklistWords"></div>
  </div>

<script>
let blocklist = [];

// Fetch blocklist from server
async function loadBlocklist() {
  try {
    const res = await fetch("/get-blocklist");
    const data = await res.json();
    blocklist = data.blocklist || [];
    renderBlocklist();
  } catch(e) {
    console.error("Failed to load blocklist", e);
  }
}

// Render blocklist
function renderBlocklist() {
  const container = document.getElementById("blocklistWords");
  container.innerHTML = "";
  blocklist.forEach(word => {
    const div = document.createElement("div");
    div.className = "blocked-word";
    div.innerHTML = `${word} <span class="remove-word" onclick="removeWord('${word}')">√ó</span>`;
    container.appendChild(div);
  });
}

// Add word
async function addWord() {
  const input = document.getElementById("newWordInput");
  const word = input.value.trim().toLowerCase();
  if(!word) return;
  const res = await fetch("/add-blockword", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ word })
  });
  const data = await res.json();
  blocklist = data.blocklist;
  input.value = "";
  renderBlocklist();
}

// Remove word
async function removeWord(word) {
  const res = await fetch("/remove-blockword", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ word })
  });
  const data = await res.json();
  blocklist = data.blocklist;
  renderBlocklist();
}

// Filter message
function filterMessage(message) {
  const lower = message.toLowerCase();
  for(const word of blocklist){
    if(lower.includes(word.toLowerCase())){
      return "[blocked]";
    }
  }
  return message;
}

// Send message
async function sendMessage() {
  const input = document.getElementById("messageInput");
  let message = input.value.trim();
  if(!message) return;

  const filtered = filterMessage(message);

  const res = await fetch("/send-message", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message })
  });
  const data = await res.json();

  const container = document.getElementById("messagesContainer");
  const div = document.createElement("div");
  div.className = "message-item" + (data.blocked ? " blocked" : "");
  div.textContent = filtered;
  container.prepend(div);

  input.value = "";
}

// Event listeners
document.getElementById("sendButton").addEventListener("click", sendMessage);
document.getElementById("addWordButton").addEventListener("click", addWord);
document.getElementById("messageInput").addEventListener("keydown", (e) => {
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

// Load blocklist on start
loadBlocklist();
</script>
</body>
</html>
