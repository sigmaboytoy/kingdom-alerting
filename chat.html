<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kingdom Alerting - Chat</title>
<style>
body { font-family: Arial,sans-serif; background:#f0f4f8; margin:0; padding:0;}
.container { max-width:600px; margin:2rem auto; background:white; padding:1rem; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
#messages { height:300px; overflow-y:auto; border:1px solid #ccc; padding:0.5rem; border-radius:8px; background:#f8fafc; margin-bottom:1rem;}
.message { padding:0.5rem; margin-bottom:0.5rem; border-radius:6px; border-left:4px solid #667eea; }
.message.blocked { border-left-color:#f56565; background:#fed7d7; }
textarea { width:100%; padding:0.5rem; border-radius:6px; border:1px solid #ccc; resize:vertical; }
button { margin-top:0.5rem; padding:0.5rem 1rem; background:#667eea; color:white; border:none; border-radius:6px; cursor:pointer; }
button:hover{background:#5568d3;}
</style>
</head>
<body>
<div class="container">
<h2>Kingdom Alerting Chat</h2>
<div id="messages"></div>
<textarea id="messageInput" rows="3" placeholder="Type your message..."></textarea>
<button id="sendBtn">Send</button>
<p id="status"></p>
</div>

<script>
const messagesDiv = document.getElementById('messages');
const sendBtn = document.getElementById('sendBtn');
const messageInput = document.getElementById('messageInput');
const statusText = document.getElementById('status');

const user = JSON.parse(localStorage.getItem('user')||'{}');
if(!user.username || !user.email) window.location.href='index.html';

const badWords = ['fuck','fck','fock','fu','shit','sh1t','shyt','bitch','b1tch','b!tch','ass','a55','dick','d1ck','damn','cunt','c*nt','whore','slut'];

const messages = JSON.parse(localStorage.getItem('messages')||'[]');

function renderMessages(){
  messagesDiv.innerHTML = '';
  messages.forEach(m=>{
    const div = document.createElement('div');
    div.className='message'+(m.blocked?' blocked':'');
    div.textContent = m.text;
    messagesDiv.appendChild(div);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
renderMessages();

sendBtn.addEventListener('click', async ()=>{
  const text = messageInput.value.trim();
  if(!text) return;

  // Local filter
  let blocked=false;
  const lower = text.toLowerCase();
  for(const word of badWords){
    if(lower.includes(word)){ blocked=true; break; }
  }

  // Send to server
  try {
    const res = await fetch('/send',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({text,user:user.username,school:user.school})
    });
    const result = await res.json();
    messages.push({text:result.text,blocked:result.blocked});
    localStorage.setItem('messages',JSON.stringify(messages));
    renderMessages();
    statusText.textContent = result.blocked ? 'Message blocked by filter' : 'Message sent!';
    statusText.style.color = result.blocked ? 'red':'green';
    messageInput.value='';
  } catch(err){
    console.error(err);
    statusText.textContent='Failed to send';
    statusText.style.color='red';
  }
});
</script>
</body>
</html>
